<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Web lÃ m bÃ i tráº¯c nghiá»‡m - ÄÃ o Háº£i Nam-CNTT K22D</title>
<style>
:root{
  --bg:#0b1220;--panel:#0e1626;--card:#101826;--text:#e5e7eb;--muted:#9aa7b8;--border:#1f2a3b;
  --accent:#22c55e;--danger:#ef4444;--warn:#f59e0b;--info:#06b6d4;--link:#60a5fa;
}
[data-theme="light"]{
  --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --text:#0b1220; --muted:#4b5563; --border:#e5e7eb;
  --accent:#16a34a; --danger:#dc2626; --warn:#f59e0b; --info:#0284c7; --link:#2563eb;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:1120px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;gap:12px;padding:8px 0 14px}
.logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:conic-gradient(from 180deg at 50% 50%, var(--accent), var(--info), #a78bfa, var(--accent));font-weight:900;color:#081019}
h1{font-size:20px;margin:0}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.p{padding:16px}
.muted{color:var(--muted)}
a{color:var(--link);text-decoration:none}
.btn{appearance:none;border:1px solid var(--border);background:#0b1220;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
.btn.primary{background:var(--accent);color:#081019;border-color:transparent;font-weight:700}
.btn.warn{background:var(--warn);color:#081019;border-color:transparent;font-weight:700}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.6;cursor:not-allowed}
input[type=text],input[type=password],input[type=number],textarea,select{width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px}
[data-theme="light"] input,[data-theme="light"] textarea,[data-theme="light"] select{background:#f8fafc;color:#0b1220}
textarea{min-height:220px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
hr{border:0;border-top:1px solid var(--border);margin:14px 0}
.chip{display:inline-flex;align-items:center;padding:4px 8px;background:#0b1220;border:1px solid var(--border);border-radius:999px;font-size:12px}
.pill{padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border)}
.row{display:grid;grid-template-columns:repeat(5,minmax(160px,1fr));gap:10px}
.col{min-width:0}
.q{border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0}
.q h3{margin:0 0 10px;font-size:16px}
.opt{display:flex;gap:10px;align-items:center;padding:8px 10px;border-radius:12px;border:1px solid transparent}
.opt:hover{background:#0b1220}
.opt-letter{min-width:28px;height:28px;border-radius:999px;border:1px solid var(--border);display:inline-grid;place-items:center;font-weight:700;opacity:.9}
.hidden{display:none!important}.space{height:8px}
/* player */
.player-head{display:flex;justify-content:space-between;gap:10px;align-items:center}
.progress{height:8px;border-radius:6px;background:#0b1220;border:1px solid var(--border);overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--info),#60a5fa);width:0%}
.navline{display:flex;justify-content:space-between;gap:8px;align-items:center}
.navline .index{font-variant-numeric:tabular-nums}
.feedback{padding:10px 12px;border-radius:12px;border:1px solid var(--border);margin-top:10px}
.feedback.ok{background:rgba(34,197,94,.15)}.feedback.bad{background:rgba(239,68,68,.12)}
.timer{font-weight:800}
/* Drag & drop */
.dd-wrap{display:flex;gap:18px;flex-wrap:wrap}
.dd-col{flex:1;min-width:260px}
.bucket{border:1px dashed var(--border);border-radius:14px;padding:10px;min-height:120px}
.drag{display:inline-block;margin:6px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0b1220;cursor:grab}
/* result */
.score-banner{margin:12px 0;padding:16px 18px;border-radius:14px;background:linear-gradient(90deg,rgba(34,197,94,.15),rgba(6,182,212,.15));border:1px solid var(--border);font-size:20px;font-weight:800}
.result{padding:12px 14px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.02)}
/* top-right badges */
.badge{border:1px solid var(--border);background:#0b1220;color:#fff;border-radius:999px;padding:6px 10px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">Q</div>
    <div>
      <h1>Web lÃ m bÃ i tráº¯c nghiá»‡m - ÄÃ o Háº£i Nam-CNTT K22D</h1>
      <div class="muted">âœ¨ Admin dÃ¡n Ä‘á» tá»« Word â€¢ Member lÃ m bÃ i (Ã”n táº­p / Kiá»ƒm tra) â€¢ Nhiá»u dáº¡ng cÃ¢u â€¢ Dark/Light mode.</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <span id="who"></span>
      <button class="btn" id="theme-toggle" title="Äá»•i giao diá»‡n">ğŸŒ™</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="view-login" class="card">
    <div class="p">
      <h3>ğŸ” ÄÄƒng nháº­p</h3>
      <label>ğŸ§‘â€ğŸ’» TÃªn Ä‘Äƒng nháº­p</label>
      <input id="login-username" type="text" placeholder="Nháº­p tÃªn tÃ i khoáº£n"/>
      <div class="space"></div>
      <label>ğŸ”‘ Máº­t kháº©u</label>
      <input id="login-password" type="password" placeholder="Nháº­p máº­t kháº©u"/>
      <div class="space"></div>
      <button class="btn primary" id="btn-login">ğŸšª VÃ o há»‡ thá»‘ng</button>
      <div id="login-note" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="view-admin" class="card hidden">
    <div class="p">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div>
          <h3>ğŸ› ï¸ Báº£ng Ä‘iá»u khiá»ƒn Admin</h3>
          <div class="muted">Dáº¥u <b>*</b> lÃ  Ä‘Ã¡p Ã¡n Ä‘Ãºng. KÃ©oâ€“tháº£: 3 dÃ²ng TrÃ¡i/Pháº£i/GhÃ©p. Äiá»n tá»«: Ä‘Ã¡p Ã¡n trong {ngoáº·c nhá»n}.</div>
        </div>
        <div>
          <span class="badge">ADMIN</span>
          <button class="btn" id="btn-logout-a">â†©ï¸ ÄÄƒng xuáº¥t</button>
        </div>
      </div>
      <hr/>

      <!-- Allowlist -->
      <div class="q">
        <h3>ğŸŸï¸ Cáº¥p quyá»n Member (Allowlist)</h3>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="acl-enabled" checked> Chá»‰ tÃ i khoáº£n trong danh sÃ¡ch dÆ°á»›i má»›i Ä‘Äƒng nháº­p Member (máº­t kháº©u máº·c Ä‘á»‹nh: <b>123</b>).</label>
        <div class="row">
          <div class="col" style="grid-column:span 3">
            <label>ThÃªm nhanh (má»—i dÃ²ng 1 tÃ i khoáº£n)</label>
            <textarea id="acl-bulk" placeholder="k22d001&#10;k22d002&#10;namdh..."></textarea>
          </div>
          <div class="col">
            <button class="btn" id="acl-add">â• ThÃªm</button>
            <div class="space"></div>
            <button class="btn warn" id="acl-clear">ğŸ§¹ XÃ³a toÃ n bá»™</button>
          </div>
        </div>
        <div class="space"></div>
        <div id="acl-list" class="muted"></div>
      </div>

      <!-- Form táº¡o Ä‘á» -->
      <div class="row">
        <div class="col"><label>ğŸ“„ TÃªn bÃ i</label><input id="exam-title"/></div>
        <div class="col"><label>ğŸ“ MÃ´n/ThÆ° má»¥c</label><input list="subject-list" id="exam-subject"/><datalist id="subject-list"></datalist></div>
        <div class="col"><label>ğŸ·ï¸ MÃ£ bÃ i</label><input id="exam-code"/></div>
        <div class="col"><label>â±ï¸ Thá»i gian (phÃºt)</label><input id="exam-min" type="number" min="1" value="45"/></div>
        <div class="col"><label>ğŸ“† Tuáº§n (tÃ¹y chá»n)</label><input id="exam-week" type="number" min="1"/></div>
      </div>
      <div class="q">
        <div class="row" style="grid-template-columns:repeat(5,minmax(140px,1fr))">
          <div class="col" style="grid-column:span 3"><label>ğŸ« Thuá»™c TrÆ°á»ng</label>
            <label class="opt" style="border:none;padding:0"><input type="checkbox" id="school-ictu"> <span style="margin-left:6px">ICTU</span></label>
            <label class="opt" style="border:none;padding:0"><input type="checkbox" id="school-tnus"> <span style="margin-left:6px">TNUS</span></label>
            <label class="opt" style="border:none;padding:0"><input type="checkbox" id="school-tump"> <span style="margin-left:6px">TUMP</span></label>
            <div class="muted" style="margin-top:4px">KhÃ´ng chá»n trÆ°á»ng nÃ o = hiá»ƒn thá»‹ á»Ÿ má»i trÆ°á»ng.</div>
          </div>
          <div class="col"><label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="exam-practice"> ğŸ§  ÄÃ¡nh dáº¥u lÃ  bÃ i Ã”n táº­p</label></div>
        </div>
      </div>
      <label>ğŸ“¥ DÃ¡n ná»™i dung tá»« Word</label>
      <textarea id="raw-input" placeholder="VÃ­ dá»¥:
CÃ¢u 1 chá»n Ä‘Ã¡p Ã¡n
*A. ÄÃºng
B. Sai
C. Sai
D. Sai

CÃ¢u 2 chá»n nhiá»u Ä‘Ã¡p Ã¡n
*A. ÄÃºng 1
*B. ÄÃºng 2
C. Sai
D. Sai

CÃ¢u 3 Ä‘iá»n tá»«
Thá»§ Ä‘Ã´ cá»§a Viá»‡t Nam lÃ  {HÃ  Ná»™i}

CÃ¢u 4 kÃ©o tháº£
TrÃ¡i: Apple; Banana
Pháº£i: Quáº£ tÃ¡o; Quáº£ chuá»‘i
GhÃ©p: Apple=Quáº£ tÃ¡o; Banana=Quáº£ chuá»‘i"></textarea>
      <div class="space"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn primary" id="btn-parse">ğŸ’¾ PhÃ¢n tÃ­ch & lÆ°u</button>
        <button class="btn ghost" id="btn-preview">ğŸ‘€ Xem trÆ°á»›c</button>
        <span class="muted" id="parse-msg"></span>
      </div>
      <hr/>
      <div id="admin-preview"></div>

      <hr/>
      <h3>ğŸ“š Kho mÃ£ Ä‘á» (theo MÃ´n)</h3>
      <div id="repo"></div>

      <!-- MIX -->
      <div id="mix-panel" class="q hidden">
        <h3>ğŸ§ª Táº¡o Ä‘á» trá»™n</h3>
        <div class="muted">ÄÃ£ chá»n: <b id="mix-count">0</b> Ä‘á».</div>
        <div class="row">
          <div class="col"><label>TiÃªu Ä‘á»</label><input id="mix-title" placeholder="Ã”n táº­p tuáº§n 1+3"/></div>
          <div class="col"><label>MÃ£</label><input id="mix-code" placeholder="mix-1-3"/></div>
          <div class="col"><label>Giá»›i háº¡n sá»‘ cÃ¢u</label><input id="mix-limit" type="number" min="1" value="50"/></div>
          <div class="col"><label>Thá»i gian</label><input id="mix-min" type="number" min="1" value="45"/></div>
          <div class="col"><label>MÃ´n</label><input list="subject-list" id="mix-subject"/></div>
        </div>
        <div class="space"></div>
        <div class="row" style="grid-template-columns:repeat(5,minmax(140px,1fr))">
          <div class="col" style="grid-column:span 3"><label>TrÆ°á»ng</label>
            <label class="opt" style="border:none;padding:0"><input type="checkbox" id="mix-ictu"> <span style="margin-left:6px">ICTU</span></label>
            <label class="opt" style="border:none;padding:0"><input type="checkbox" id="mix-tnus"> <span style="margin-left:6px">TNUS</span></label>
            <label class="opt" style="border:none;padding:0"><input type="checkbox" id="mix-tump"> <span style="margin-left:6px">TUMP</span></label>
          </div>
          <div class="col"><label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="mix-practice"> Ã”n táº­p</label></div>
        </div>
        <div class="space"></div>
        <button class="btn primary" id="btn-mix-create">âœ¨ Táº¡o Ä‘á» trá»™n</button>
        <button class="btn ghost" id="btn-mix-clear">ğŸ§½ Bá» chá»n</button>
      </div>

      <hr/>
      <h3>ğŸ—‚ï¸ Quáº£n lÃ½ ThÆ° má»¥c/MÃ´n</h3>
      <div class="q">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="new-subject" style="max-width:260px" placeholder="TÃªn mÃ´n má»›i"/>
          <button class="btn" id="btn-add-subject">â• ThÃªm thÆ° má»¥c</button>
          <span class="muted">CÃ³ thá»ƒ khÃ³a thÆ° má»¥c Ä‘á»ƒ Member khÃ´ng tháº¥y Ä‘á» trong thÆ° má»¥c Ä‘Ã³.</span>
        </div>
        <div id="subject-manager" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- MEMBER -->
  <section id="view-member" class="card hidden">
    <div class="p">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div>
          <h3>ğŸ“œ Danh sÃ¡ch bÃ i</h3>
          <div class="muted">Náº¿u cÃ³ cÃ¢u há»i má»›i hoáº·c Ä‘Ã¡p Ã¡n sai, liÃªn há»‡ Zalo/SÄT: <b>0379859082</b>.</div>
        </div>
        <div>
          <span class="badge">MEMBER</span>
          <button class="btn" id="btn-logout-m">â†©ï¸ ÄÄƒng xuáº¥t</button>
        </div>
      </div>
      <hr/>
      <div id="exam-list"></div>
      <div id="exam-play" class="hidden"></div>
    </div>
  </section>
</div>

<script>
/* ===== Storage & helpers ===== */
const KEY='quizData';
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const DB={load(){const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):{users:{},subjects:{},acl:{enabled:true,list:[]}}},save(d){localStorage.setItem(KEY,JSON.stringify(d))}};
const shuffled=a=>{const x=a.slice();for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]]}return x;}
const deep=x=>JSON.parse(JSON.stringify(x));
const norm=s=>(s||'').toString().trim().toLowerCase().replace(/\s+/g,' ');
const escapeHtml=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const cleanOption=t=>{let x=(t||'').trim();const star=x.startsWith('*')||x.includes(' *');x=x.replace(/\*/g,'').replace(/^([A-Da-d]|\d{1,2})[.)-: ]+\s*/,'').replace(/^[âˆ’â€“-â€¢]+\s*/,'');return{text:x.trim(),star};};
// Ä‘á» khÃ´ng gÃ¡n trÆ°á»ng -> hiá»ƒn thá»‹ cho má»i trÆ°á»ng
const visibleForSchool=(ex,school)=>{const arr=Array.isArray(ex.schools)?ex.schools:[];return arr.length===0 || arr.includes(school);};
function motivational(sc){if(sc>=9)return'ğŸ†ğŸ‰ Xuáº¥t sáº¯c!';if(sc>=8)return'ğŸŒŸ Ráº¥t tá»‘t! Cá»‘ lÃªn nÃ o!';if(sc>=7)return'ğŸ‘ á»”n rá»“i, pháº¥n Ä‘áº¥u 9â€“10 nhÃ©!';if(sc>=5)return'ğŸ™‚ Cáº§n luyá»‡n thÃªm!';return'ğŸ’ª Äá»«ng bá» cuá»™c!';}

/* ===== Theme (Dark/Light) ===== */
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('quiz-theme', theme);
  const btn = document.getElementById('theme-toggle');
  if(btn) btn.textContent = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
}
(function initTheme(){
  const saved = localStorage.getItem('quiz-theme') || 'dark';
  applyTheme(saved);
  const btn = document.getElementById('theme-toggle');
  if(btn){ btn.onclick = ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='light'?'dark':'light'); }
})();

/* ===== Auth & Route ===== */
let state={me:null,mix:new Set()};
function setWho(){ $('#who').innerHTML=state.me?`<span class="chip">${state.me.username}</span> <span class="pill">${state.me.role.toUpperCase()}</span>`:'';}
function route(){
  ['#view-login','#view-admin','#view-member'].forEach(s=>$(s).classList.add('hidden'));
  if(!state.me) $('#view-login').classList.remove('hidden');
  else if(state.me.role==='admin'){ $('#view-admin').classList.remove('hidden'); renderDatalist(); renderACL(); renderRepo(); }
  else { $('#view-member').classList.remove('hidden'); renderExamList(); }
  setWho();
}
$('#btn-login').onclick=()=>{
  const u=$('#login-username').value.trim(), p=$('#login-password').value;
  if(u==='NamQT'&&p==='070905'){ state.me={username:u,role:'admin'}; route(); return; }
  const db=DB.load();
  if(db.acl.enabled && !db.acl.list.map(norm).includes(norm(u))){ $('#login-note').textContent='â›” TÃ i khoáº£n chÆ°a Ä‘Æ°á»£c cáº¥p quyá»n Member.'; return; }
  if(!db.users[u]){ if(p!=='123'){ $('#login-note').textContent='Sai máº­t kháº©u. Gá»£i Ã½: 123'; return; } db.users[u]={username:u,role:'member',password:'123'}; DB.save(db); }
  if(db.users[u].password===p){ state.me=db.users[u]; route(); } else $('#login-note').textContent='Sai thÃ´ng tin Ä‘Äƒng nháº­p.';
};
$('#btn-logout-a').onclick=()=>{state.me=null; route();};
$('#btn-logout-m').onclick=()=>{state.me=null; route();};

/* ===== ACL ===== */
function renderACL(){
  const db=DB.load(); $('#acl-enabled').checked=!!db.acl.enabled;
  const list=$('#acl-list'); list.innerHTML='';
  if(!db.acl.list.length) list.innerHTML='<span class="muted">ChÆ°a cÃ³ tÃ i khoáº£n nÃ o.</span>';
  else db.acl.list.sort().forEach(name=>{
    const chip=document.createElement('span'); chip.className='chip'; chip.style.margin='4px';
    chip.innerHTML=`${name} <button style="margin-left:6px;background:transparent;border:0;color:#fca5a5;cursor:pointer">âœ–</button>`;
    chip.querySelector('button').onclick=()=>{const d=DB.load(); d.acl.list=d.acl.list.filter(x=>x!==name); DB.save(d); renderACL();};
    list.appendChild(chip);
  });
  $('#acl-enabled').onchange=e=>{const d=DB.load(); d.acl.enabled=e.target.checked; DB.save(d);};
  $('#acl-add').onclick=()=>{const raw=$('#acl-bulk').value.trim(); if(!raw) return; const adds=raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const d=DB.load(); const set=new Set(d.acl.list); adds.forEach(x=>set.add(x)); d.acl.list=[...set]; DB.save(d); $('#acl-bulk').value=''; renderACL();};
  $('#acl-clear').onclick=()=>{if(!confirm('XÃ³a toÃ n bá»™ danh sÃ¡ch?'))return; const d=DB.load(); d.acl.list=[]; DB.save(d); renderACL();};
}

/* ===== Parser ===== */
function parseExam(raw){
  const blocks=raw.replace(/\r\n/g,'\n').split(/\n{2,}/).map(s=>s.trim()).filter(Boolean); const qs=[];
  for(const block of blocks){
    const lines=block.split(/\n/).map(s=>s.trim()).filter(Boolean);
    const head=(lines.shift()||'').toLowerCase(); if(!head.startsWith('cÃ¢u')) continue;
    if(head.includes('kÃ©o tháº£')){
      let left=[],right=[],map={};
      for(const ln of lines){
        if(/^trÃ¡i\s*:/i.test(ln)) left=ln.split(':')[1].split(';').map(s=>s.trim()).filter(Boolean);
        else if(/^pháº£i\s*:/i.test(ln)) right=ln.split(':')[1].split(';').map(s=>s.trim()).filter(Boolean);
        else if(/^ghÃ©p\s*:/i.test(ln)){const pairs=ln.split(':')[1].split(';'); for(const p of pairs){const [L,R]=p.split('='); if(L&&R) map[L.trim()]=R.trim();}}
      }
      qs.push({type:'drag',prompt:block.split('\n')[0],left,right,map}); continue;
    }
    if(head.includes('Ä‘iá»n tá»«')){
      const m=block.match(/\{([^}]+)\}/); const ans=m?m[1].trim():'';
      const prompt=block.replace(/\{[^}]+\}/,'_____');
      qs.push({type:'fill',prompt:prompt.split('\n')[0],answer:ans}); continue;
    }
    const opts=lines.map(cleanOption).filter(o=>o.text); const correctIdx=opts.map((o,i)=>o.star?i:-1).filter(i=>i>=0);
    qs.push({type:correctIdx.length>1?'multi':'single',prompt:block.split('\n')[0],options:opts.map(o=>o.text),correct:correctIdx.length>1?correctIdx:correctIdx[0]});
  }
  return qs;
}

/* ===== Save / Datalist ===== */
function saveExamToDB(ex){ const db=DB.load(); const subj=ex.subject||'Chung'; if(!db.subjects[subj]) db.subjects[subj]={locked:false,exams:{}}; db.subjects[subj].exams[ex.code]=ex; DB.save(db); }
function renderDatalist(){ const db=DB.load(); const dl=$('#subject-list'); dl.innerHTML=Object.keys(db.subjects).sort().map(s=>`<option value="${s}">`).join(''); }

/* ===== Admin: táº¡o Ä‘á» ===== */
$('#btn-preview').onclick=()=>{const raw=$('#raw-input').value.trim(); if(!raw){alert('ChÆ°a cÃ³ ná»™i dung');return;} renderAdminPreview(parseExam(raw));};
$('#btn-parse').onclick=()=>{
  const raw=$('#raw-input').value.trim(), code=$('#exam-code').value.trim(), title=$('#exam-title').value.trim(), subject=($('#exam-subject').value.trim()||'Chung');
  if(!raw||!code||!title){alert('Äiá»n Ä‘á»§ TÃªn bÃ i, MÃ£ vÃ  Ná»™i dung.');return;}
  const picked=[]; if($('#school-ictu').checked)picked.push('ICTU'); if($('#school-tnus').checked)picked.push('TNUS'); if($('#school-tump').checked)picked.push('TUMP');
  const ex={code,title,subject,week:$('#exam-week').value?Number($('#exam-week').value):null,minutes:Number($('#exam-min').value)||45,
    questions:parseExam(raw),createdAt:Date.now(),schools:picked,practice:$('#exam-practice').checked,published:true};
  saveExamToDB(ex); $('#parse-msg').textContent=`âœ… LÆ°u ${ex.questions.length} cÃ¢u cho â€œ${ex.title}â€ & Ä‘Ã£ xuáº¥t báº£n.`; renderAdminPreview(ex.questions); renderRepo(); renderDatalist();
};
function renderAdminPreview(qs){ const root=$('#admin-preview'); root.innerHTML=''; const frag=document.createDocumentFragment(); qs.forEach((q,i)=>{ const el=document.createElement('div'); el.className='q'; el.innerHTML=`<h3>ğŸ§© CÃ¢u ${i+1} â€“ ${labelType(q)}</h3>`+renderQuestion(q,true); frag.appendChild(el);}); root.appendChild(frag);}
function labelType(q){ if(q.type==='single')return'Chá»n 1 Ä‘Ã¡p Ã¡n'; if(q.type==='multi')return(q.correct||[]).length>1?`Chá»n ${(q.correct||[]).length} Ä‘Ã¡p Ã¡n`:'Chá»n nhiá»u Ä‘Ã¡p Ã¡n'; return q.type==='drag'?'KÃ©o tháº£':'Äiá»n tá»«'; }

/* ===== Admin: Repo & Mix ===== */
function updateMixPanel(){ const n=state.mix.size; $('#mix-count').textContent=n; $('#mix-panel').classList.toggle('hidden',n===0); }
$('#btn-mix-clear').onclick=()=>{state.mix.clear(); renderRepo(); updateMixPanel();}
$('#btn-mix-create').onclick=()=>{
  if(state.mix.size===0){alert('ChÆ°a chá»n Ä‘á» Ä‘á»ƒ trá»™n');return;}
  const db=DB.load(); let pool=[], subject='', union=new Set();
  state.mix.forEach(code=>{
    Object.values(db.subjects).forEach(s=>{ if(s.exams[code]){const ex=s.exams[code]; pool=pool.concat(ex.questions); if(!subject) subject=ex.subject; (ex.schools||[]).forEach(x=>union.add(x)); }});
  });
  const ex={code:($('#mix-code').value.trim()||('mix-'+Date.now())), title:($('#mix-title').value.trim()||'Äá» trá»™n'),
    subject:($('#mix-subject').value.trim()||subject||'Chung'), week:null, minutes:Number($('#mix-min').value)||45,
    questions:shuffled(pool).slice(0,Math.max(1,Number($('#mix-limit').value)||50)), createdAt:Date.now(),
    schools: (['ICTU','TNUS','TUMP'].filter(s=>$('#mix-'+s.toLowerCase()).checked).length? ['ICTU','TNUS','TUMP'].filter(s=>$('#mix-'+s.toLowerCase()).checked) : [...union]),
    practice:$('#mix-practice').checked, published:true, mix:true };
  saveExamToDB(ex); alert(`ğŸ‰ ÄÃ£ táº¡o â€œ${ex.title}â€ (${ex.questions.length} cÃ¢u) & xuáº¥t báº£n.`);
  state.mix.clear(); renderRepo(); renderDatalist(); updateMixPanel();
};
function renderRepo(){
  const db=DB.load(); const root=$('#repo'); root.innerHTML='';
  const subs=Object.keys(db.subjects).sort(); if(!subs.length){root.innerHTML='<div class="muted">ChÆ°a cÃ³ mÃ£ Ä‘á» nÃ o.</div>'; return;}
  subs.forEach(sub=>{
    const folder=db.subjects[sub], box=document.createElement('div'); const locked=!!folder.locked;
    box.className='q'; box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">ğŸ“ ${sub} ${locked?'<span class="pill">LOCKED</span>':''}</div>
      <div>
        <button class="btn" data-act="toggle" data-sub="${sub}">${locked?'ğŸ”“ Má»Ÿ khÃ³a':'ğŸ”’ KhÃ³a'}</button>
        <button class="btn warn" data-act="del-folder" data-sub="${sub}">ğŸ—‘ï¸ XÃ³a thÆ° má»¥c</button>
      </div></div>
      <div class="repo-g"></div>`;
    const g=box.querySelector('.repo-g');
    const exams=Object.values(folder.exams||{}).sort((a,b)=>(a.week||999)-(b.week||999)||a.title.localeCompare(b.title));
    const frag=document.createDocumentFragment();
    exams.forEach(ex=>{
      const checked=state.mix.has(ex.code)?'checked':''; const pub=ex.published;
      const line=document.createElement('div'); line.style.display='flex'; line.style.gap='10px'; line.style.alignItems='center'; line.style.justifyContent='space-between'; line.style.padding='6px 0';
      line.innerHTML=`<div style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" data-pick="${ex.code}" ${checked} title="Chá»n Ä‘á»ƒ trá»™n"/>
        <div><b>${ex.title}</b> <span class="muted">â€¢ ${ex.questions.length} cÃ¢u â€¢ ${ex.minutes}p â€¢ MÃ£: ${ex.code}${ex.week?' â€¢ Tuáº§n '+ex.week:''}${ex.practice?' â€¢ Ã”n táº­p':''}${pub?' â€¢ âœ… Xuáº¥t báº£n':' â€¢ â›” áº¨n'}</span></div>
      </div>
      <div>
        <button class="btn" data-peek="${ex.code}">ğŸ‘ï¸ Xem</button>
        <button class="btn" data-edit="${ex.code}">â¬†ï¸ Náº¡p Ä‘á»ƒ sá»­a</button>
        <button class="btn" data-pub="${ex.code}">${pub?'ğŸ™ˆ áº¨n':'âœ… Xuáº¥t báº£n'}</button>
        <button class="btn warn" data-del="${ex.code}">ğŸ—‘ï¸ XÃ³a Ä‘á»</button>
      </div>`;
      frag.appendChild(line);
    });
    g.appendChild(frag);

    box.addEventListener('click',e=>{
      const db2=DB.load();
      const pick=e.target.closest('input[data-pick]'); if(pick){ const c=pick.getAttribute('data-pick'); if(pick.checked) state.mix.add(c); else state.mix.delete(c); updateMixPanel(); return; }
      const act=e.target.closest('button'); if(!act) return;
      if(act.dataset.act==='toggle'){ db2.subjects[sub].locked=!db2.subjects[sub].locked; DB.save(db2); renderRepo(); return; }
      if(act.dataset.act==='del-folder'){ if(Object.keys(db2.subjects[sub].exams||{}).length){alert('ThÆ° má»¥c chÆ°a rá»—ng. HÃ£y xÃ³a Ä‘á» trÆ°á»›c.');return;} delete db2.subjects[sub]; DB.save(db2); renderRepo(); renderDatalist(); return; }
      const code=act.dataset.peek||act.dataset.edit||act.dataset.del||act.dataset.pub;
      const ex=db2.subjects[sub].exams[code]; if(!ex) return;
      if(act.dataset.peek){ const prev=document.createElement('div'); prev.className='q'; prev.innerHTML='<div class="muted">Xem nhanh:</div>'+ex.questions.slice(0,3).map(q=>`<div class="muted">â€¢ ${q.type}</div>`).join('')+(ex.questions.length>3?`<div class="muted">â€¦ +${ex.questions.length-3} cÃ¢u</div>`:''); box.appendChild(prev); setTimeout(()=>prev.remove(),2500); }
      if(act.dataset.edit){ $('#exam-title').value=ex.title; $('#exam-code').value=ex.code; $('#exam-subject').value=sub; $('#exam-min').value=ex.minutes; $('#exam-week').value=ex.week||''; $('#school-ictu').checked=(ex.schools||[]).includes('ICTU'); $('#school-tnus').checked=(ex.schools||[]).includes('TNUS'); $('#school-tump').checked=(ex.schools||[]).includes('TUMP'); $('#exam-practice').checked=!!ex.practice; window.scrollTo({top:0,behavior:'smooth'}); alert('ÄÃ£ náº¡p thÃ´ng tin Ä‘á» lÃªn form.'); }
      if(act.dataset.pub){ ex.published=!ex.published; db2.subjects[sub].exams[code]=ex; DB.save(db2); renderRepo(); }
      if(act.dataset.del){ if(confirm('XÃ³a Ä‘á» nÃ y?')){ delete db2.subjects[sub].exams[code]; state.mix.delete(code); DB.save(db2); renderRepo(); updateMixPanel(); } }
    });

    root.appendChild(box);
  });

  // subject manager
  const mgr=$('#subject-manager'); mgr.innerHTML='';
  subs.forEach(sub=>{
    const locked=!!db.subjects[sub].locked; const row=document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0';
    row.innerHTML=`<div><b>${sub}</b> ${locked?'<span class="pill">LOCKED</span>':''}</div>
      <div><button class="btn" data-sm="toggle" data-sub="${sub}">${locked?'ğŸ”“ Má»Ÿ khÃ³a':'ğŸ”’ KhÃ³a'}</button>
      <button class="btn warn" data-sm="del" data-sub="${sub}">ğŸ—‘ï¸ XÃ³a</button></div>`;
    row.addEventListener('click',e=>{
      const b=e.target.closest('button'); if(!b) return; const d=DB.load();
      if(b.dataset.sm==='toggle'){ d.subjects[sub].locked=!d.subjects[sub].locked; DB.save(d); renderRepo(); }
      if(b.dataset.sm==='del'){ if(Object.keys(d.subjects[sub].exams||{}).length){alert('ThÆ° má»¥c chÆ°a rá»—ng.');return;} delete d.subjects[sub]; DB.save(d); renderRepo(); renderDatalist(); }
    });
    mgr.appendChild(row);
  });

  $('#btn-add-subject').onclick=()=>{ const name=$('#new-subject').value.trim(); if(!name) return; const d=DB.load(); if(!d.subjects[name]) d.subjects[name]={locked:false,exams:{}}; DB.save(d); $('#new-subject').value=''; renderRepo(); renderDatalist(); };

  updateMixPanel();
}

/* ===== Member: chá»n TrÆ°á»ng â†’ MÃ´n â†’ Tuáº§n/Ã”n táº­p ===== */
function renderExamList(){
  const db=DB.load(); const root=$('#exam-list'); const host=$('#exam-play'); host.classList.add('hidden'); host.innerHTML=''; root.innerHTML='';
  const schools=['ICTU','TNUS','TUMP']; const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(3,minmax(160px,1fr))'; grid.style.gap='10px';
  schools.forEach(sc=>{ const card=document.createElement('div'); card.className='q'; card.style.cursor='pointer'; card.innerHTML=`<div style="font-weight:800;font-size:18px">ğŸ« ${sc}</div><div class="muted">Nháº¥n Ä‘á»ƒ chá»n</div>`; card.onclick=()=>showSubjects(sc); grid.appendChild(card); });
  root.appendChild(grid);

  function back(cb){ const b=document.createElement('button'); b.className='btn'; b.textContent='â† Quay láº¡i'; b.style.marginBottom='10px'; b.onclick=cb; return b; }

  function showSubjects(sc){
    root.innerHTML=''; root.appendChild(back(()=>renderExamList())); root.insertAdjacentHTML('beforeend', `<h3>${sc} â€“ Chá»n MÃ´n</h3>`);
    const subs=Object.entries(db.subjects)
      .filter(([name,folder])=>!folder.locked && Object.values(folder.exams||{}).some(ex=>ex.published && visibleForSchool(ex, sc)))
      .map(([n])=>n).sort();
    if(!subs.length){root.insertAdjacentHTML('beforeend','<div class="muted">ChÆ°a cÃ³ mÃ´n nÃ o.</div>');return;}
    const g=document.createElement('div'); g.style.display='grid'; g.style.gridTemplateColumns='repeat(3,minmax(160px,1fr))'; g.style.gap='10px';
    subs.forEach(s=>{ const c=document.createElement('div'); c.className='q'; c.style.cursor='pointer'; c.innerHTML=`<div style="font-weight:700">ğŸ“˜ ${s}</div>`; c.onclick=()=>showWeeks(sc,s); g.appendChild(c); });
    root.appendChild(g);
  }

  function showWeeks(sc,subject){
    root.innerHTML=''; root.appendChild(back(()=>showSubjects(sc))); root.insertAdjacentHTML('beforeend', `<h3>${sc} / ${subject} â€“ Tuáº§n vÃ  Ã”n táº­p</h3>`);
    const folder=db.subjects[subject]; const list=Object.values(folder.exams||{}).filter(ex=>ex.published && visibleForSchool(ex, sc));
    const weeks=[...new Set(list.map(ex=>ex.week).filter(Boolean))].sort((a,b)=>a-b);
    const g=document.createElement('div'); g.style.display='grid'; g.style.gridTemplateColumns='repeat(4,minmax(120px,1fr))'; g.style.gap='10px';
    weeks.forEach(w=>{ const c=document.createElement('div'); c.className='q'; c.style.cursor='pointer'; c.innerHTML=`<div style="font-weight:700">ğŸ“… Tuáº§n ${w}</div>`; c.onclick=()=>showExams(sc,subject,w,false); g.appendChild(c); });
    if(list.some(ex=>ex.practice)){ const p=document.createElement('div'); p.className='q'; p.style.cursor='pointer'; p.innerHTML=`<div style="font-weight:700">ğŸ§  Ã”n táº­p</div>`; p.onclick=()=>showExams(sc,subject,null,true); g.appendChild(p); }
    if(g.children.length===0) root.insertAdjacentHTML('beforeend','<div class="muted">ChÆ°a cÃ³ tuáº§n hoáº·c bÃ i Ã´n táº­p.</div>'); else root.appendChild(g);
  }

  function showExams(sc,subject,week,practice){
    root.innerHTML=''; root.appendChild(back(()=>showWeeks(sc,subject))); root.insertAdjacentHTML('beforeend', `<h3>${sc} / ${subject} / ${practice?'Ã”n táº­p':'Tuáº§n '+week}</h3>`);
    const list=Object.values(db.subjects[subject].exams||{})
      .filter(ex=>ex.published && visibleForSchool(ex, sc) && (practice?ex.practice:ex.week===week))
      .sort((a,b)=>b.createdAt-a.createdAt);
    if(!list.length){root.insertAdjacentHTML('beforeend','<div class="muted">ChÆ°a cÃ³ Ä‘á».</div>');return;}
    const frag=document.createDocumentFragment();
    list.forEach(ex=>{
      const row=document.createElement('div'); row.className='q';
      row.innerHTML=`<div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div><div style="font-weight:700">ğŸ“ ${ex.title}</div><div class="muted">${ex.questions.length} cÃ¢u â€¢ ${ex.minutes}p â€¢ MÃ£: ${ex.code}${ex.practice?' â€¢ Ã”n táº­p':''}</div></div>
        <div>
          <label class="pill" style="margin-right:8px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center"><input type="radio" name="mode-${ex.code}" value="practice" checked> Ã”n táº­p</label>
          <label class="pill" style="margin-right:8px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center"><input type="radio" name="mode-${ex.code}" value="exam"> Kiá»ƒm tra</label>
          <button class="btn primary">ğŸš€ Báº¯t Ä‘áº§u</button>
        </div>
      </div>`;
      row.querySelector('button').onclick=()=>{const mode=row.querySelector('input[name="mode-'+ex.code+'"]:checked').value; startExam1Q(ex,mode);};
      frag.appendChild(row);
    });
    root.appendChild(frag);
  }
}

/* ===== Render Question ===== */
function renderQuestion(q,preview=false,qi=0){
  const letter=i=>String.fromCharCode(65+i);
  if(q.type==='single') return `<div>${escapeHtml(q.prompt)}</div>`+q.options.map((o,i)=>`<label class="opt"><span class="opt-letter">${letter(i)}</span><input ${preview?'disabled':''} data-q="${qi}" data-type="single" type="radio" name="q${qi}" value="${i}" style="margin-left:6px"/><div>${escapeHtml(o)}</div></label>`).join('');
  if(q.type==='multi') return `<div>${escapeHtml(q.prompt)} <span class="muted">(Chá»n ${(q.correct||[]).length})</span></div>`+q.options.map((o,i)=>`<label class="opt"><span class="opt-letter">${letter(i)}</span><input ${preview?'disabled':''} data-q="${qi}" data-type="multi" type="checkbox" value="${i}" style="margin-left:6px"/><div>${escapeHtml(o)}</div></label>`).join('');
  if(q.type==='fill') return `<div style="margin-bottom:8px">${escapeHtml(q.prompt)}</div><input ${preview?'disabled':''} data-q="${qi}" data-type="fill" type="text" placeholder="Nháº­p Ä‘Ã¡p Ã¡n..."/>`;
  if(q.type==='drag'){ const L=q.left||[],R=q.right||[]; return `<div class="dd-wrap"><div class="dd-col"><div class="muted" style="margin-bottom:6px">KÃ©o máº£nh</div><div class="bucket" style="min-height:auto">${L.map(x=>`<span draggable="${preview?'false':'true'}" class="drag">${escapeHtml(x)}</span>`).join('')}</div></div><div class="dd-col"><div class="muted" style="margin-bottom:6px">Tháº£ vÃ o Ä‘Ãºng Ã´</div>${R.map(r=>`<div class="bucket" data-q="${qi}" data-right="${escapeHtml(r)}">${escapeHtml(r)}</div>`).join('')}</div></div>`;}
  return '';
}

/* ===== Player 1-cÃ¢u/1-mÃ n (Ã”n táº­p: chá»‰ cháº¥m khi báº¥m; nÃºt cháº¥m = chuyá»ƒn) ===== */
function startExam1Q(ex,mode){
  const host=$('#exam-play'), list=$('#exam-list'); list.innerHTML=''; host.classList.remove('hidden'); host.innerHTML='';
  const work=deep(ex);
  work.questions=shuffled(work.questions).map(q=>{
    if(q.type==='single'||q.type==='multi'){
      const perm=shuffled(q.options.map((_,i)=>i)), opts=perm.map(i=>q.options[i]);
      if(q.type==='single') return {...q,options:opts,correct:perm.indexOf(q.correct)};
      return {...q,options:opts,correct:q.correct.map(c=>perm.indexOf(c)).sort((a,b)=>a-b)};
    } return q;
  });

  let idx=0, remain=(ex.minutes||45)*60, intv=null;
  const answers={}, answered=new Set();

  host.innerHTML=`<div class="q">
    <div class="player-head"><div><b>ğŸ“ ${ex.title}</b> <span class="muted">â€¢ ${work.questions.length} cÃ¢u â€¢ ${ex.minutes} phÃºt â€¢ Cháº¿ Ä‘á»™: ${mode==='practice'?'Ã”n táº­p':'Kiá»ƒm tra'}</span></div><div class="timer" id="timer">${mode==='exam'?'--:--':'â¸ï¸'}</div></div>
    <div class="progress" style="margin:10px 0 4px"><i id="bar"></i></div>
    <div class="navline"><div class="index" id="idx">CÃ¢u 1/${work.questions.length}</div><div id="step-msg" class="muted"></div></div>
  </div>
  <div id="slot" class="q"></div>
  <div class="q" style="display:flex;gap:8px;align-items:center;justify-content:space-between">
    <div>
      <button class="btn" id="btn-prev">â¬…ï¸ TrÆ°á»›c</button>
      <button class="btn" id="btn-next"${mode==='practice'?' disabled':''}>â¡ï¸ Sau</button>
    </div>
    <div>
      <button class="btn" id="btn-exit">â¹ï¸ ThoÃ¡t</button>
      ${mode==='exam'?'<button class="btn primary" id="btn-submit">ğŸ“¤ Ná»™p bÃ i</button>':'<button class="btn primary" id="btn-check-next">âœ… Kiá»ƒm tra / Tiáº¿p theo</button>'}
    </div>
  </div>
  <div id="feedback" class="hidden"></div>
  <div id="review"></div>`;

  const slot=$('#slot'), idxEl=$('#idx'), bar=$('#bar'), fb=$('#feedback'), review=$('#review'), step=$('#step-msg');
  const btnPrev=$('#btn-prev'), btnNext=$('#btn-next'), btnCheckNext=$('#btn-check-next');

  function setProgress(){ bar.style.width=((idx)/work.questions.length*100)+'%'; idxEl.textContent=`CÃ¢u ${idx+1}/${work.questions.length}`; }
  function isCorrect(q,ans){
    if(q.type==='single') return ans===q.correct;
    if(q.type==='multi'){ const a=Array.isArray(ans)?ans:[]; return JSON.stringify(a)===JSON.stringify((q.correct||[]).slice().sort((x,y)=>x-y)); }
    if(q.type==='fill'){ return norm(ans)===norm(q.answer||''); }
    if(q.type==='drag'){ const need=Object.keys(q.map||{}).length; let ok=0; (Array.isArray(ans)?ans:[]).forEach(([L,R])=>{ if((q.map||{})[L]===R) ok++; }); return ok===need&&need>0; }
    return false;
  }

  function draw(){
    const q=work.questions[idx];
    slot.innerHTML=`<h3>ğŸ§© ${labelType(q)}</h3>`+renderQuestion(q,false,idx);
    fb.className='hidden'; fb.innerHTML='';
    step.textContent= mode==='practice' ? 'Chá»n Ä‘Ã¡p Ã¡n, sau Ä‘Ã³ báº¥m â€œKiá»ƒm tra / Tiáº¿p theoâ€.' : 'LÃ m háº¿t rá»“i báº¥m Ná»™p bÃ i.';
    capture();
  }

  function capture(){
    slot.querySelectorAll('[data-q]').forEach(el=>{
      el.onchange=(e)=>{
        const i=+e.target.getAttribute('data-q');
        const t=e.target.getAttribute('data-type');
        if(t==='single'){ answers[i]=+e.target.value; answered.add(i); }
        else if(t==='multi'){ const set=new Set(answers[i]||[]); if(e.target.checked) set.add(+e.target.value); else set.delete(+e.target.value); answers[i]=[...set].sort((a,b)=>a-b); if((answers[i]||[]).length>0) answered.add(i); else answered.delete(i); }
        else if(t==='fill'){ answers[i]=e.target.value.trim(); if(answers[i]) answered.add(i); else answered.delete(i); }
      }
    });
    slot.addEventListener('dragstart',e=>{ if(e.target.classList.contains('drag')) e.dataTransfer.setData('text/plain',e.target.textContent); });
    slot.addEventListener('dragover',e=>{ if(e.target.classList.contains('bucket')) e.preventDefault(); });
    slot.addEventListener('drop',e=>{
      if(e.target.classList.contains('bucket')){
        e.preventDefault();
        const text=e.dataTransfer.getData('text/plain');
        const qi=+e.target.getAttribute('data-q'); const right=e.target.getAttribute('data-right');
        const chip=document.createElement('span'); chip.className='drag'; chip.textContent=text; e.target.appendChild(chip);
        const pair=answers[qi]||[]; pair.push([text,right]); answers[qi]=pair; if((answers[qi]||[]).length>0) answered.add(qi);
      }
    });
  }

  function next(){ if(idx<work.questions.length-1){ idx++; setProgress(); draw(); } }
  function prev(){ if(idx>0){ idx--; setProgress(); draw(); } }

  btnPrev.onclick=prev;
  if(btnNext) btnNext.onclick=next;
  $('#btn-exit').onclick=()=>{clearInterval(intv); renderExamList();};

  // Practice: â€œKiá»ƒm tra / Tiáº¿p theoâ€
  if(btnCheckNext){
    btnCheckNext.onclick=()=>{
      const q=work.questions[idx];
      const ans=answers[idx];
      if(!answered.has(idx)){ fb.className='feedback bad'; fb.innerHTML='âš ï¸ Báº¡n chÆ°a chá»n Ä‘Ã¡p Ã¡n!'; return; }
      const ok=isCorrect(q,ans);
      fb.className='feedback '+(ok?'ok':'bad');
      if(q.type==='single'||q.type==='multi'){
        const L=k=>String.fromCharCode(65+k);
        const your=(q.type==='single'?(ans!=null?L(ans):'â€”'):(ans||[]).map(L).join(', ')||'â€”');
        const corr=(q.type==='single'?L(q.correct):q.correct.map(L).join(', '));
        fb.innerHTML=`${ok?'âœ… ÄÃºng':'âŒ Sai'} â€¢ Báº¡n: <b>${your}</b> â€¢ ÄÃºng: <b>${corr}</b>`;
      }else if(q.type==='fill'){
        fb.innerHTML=`${ok?'âœ… ÄÃºng':'âŒ Sai'} â€¢ ÄÃºng: <b>${escapeHtml(q.answer)}</b>`;
      }else{
        fb.innerHTML=`${ok?'âœ… ÄÃºng':'âŒ Sai'} â€¢ GhÃ©p Ä‘á»§ cÃ¡c cáº·p.`;
      }
      setTimeout(()=>{
        if(idx===work.questions.length-1){
          // tá»•ng káº¿t Ä‘iá»ƒm cho cháº¿ Ä‘á»™ Ã´n táº­p
          let okCount=0; work.questions.forEach((qq,i)=>{ if(isCorrect(qq,answers[i])) okCount++; });
          const sc=Math.round((okCount/work.questions.length)*100)/10;
          const banner=document.createElement('div'); banner.className='score-banner';
          banner.innerHTML=`Äiá»ƒm: ${sc} / 10 <span style="margin-left:10px">${motivational(sc)}</span>`;
          review.prepend(banner);
          btnCheckNext.disabled=true; btnPrev.disabled=true;
          window.scrollTo({top:0,behavior:'smooth'});
        }else{ next(); }
      },900);
    };
  }

  // Exam mode: Ä‘á»“ng há»“ + ná»™p cuá»‘i
  if(mode==='exam'){
    const timer=$('#timer');
    function tick(){ const m=Math.floor(remain/60).toString().padStart(2,'0'); const s=(remain%60).toString().padStart(2,'0'); timer.textContent=`${m}:${s}`; if(remain<=0){clearInterval(intv); grade();} remain--; }
    tick(); intv=setInterval(tick,1000);
    $('#btn-submit').onclick=grade;
  }

  function grade(){
    let ok=0; work.questions.forEach((q,i)=>{ if(isCorrect(q,answers[i])) ok++; });
    const sc=Math.round((ok/work.questions.length)*100)/10;
    const banner=document.createElement('div'); banner.className='score-banner'; banner.innerHTML=`Äiá»ƒm: ${sc} / 10 <span style="margin-left:10px">${motivational(sc)}</span>`;
    review.prepend(banner);
    review.innerHTML += work.questions.map((q,i)=>{const ans=answers[i];const good=isCorrect(q,ans); const L=k=>String.fromCharCode(65+k); let detail=''; if(q.type==='single'||q.type==='multi'){const your=(q.type==='single'?(ans!=null?L(ans):'â€”'):(ans||[]).map(L).join(', ')||'â€”'); const corr=(q.type==='single'?L(q.correct):q.correct.map(L).join(', ')); detail=`Báº¡n: ${your} â€¢ ÄÃºng: ${corr}`;} else if(q.type==='fill'){detail=`Báº¡n: <code>${ans||'â€”'}</code> â€¢ ÄÃºng: <code>${escapeHtml(q.answer)}</code>`;} else detail=`GhÃ©p ${(Array.isArray(ans)?ans.length:0)}/${Object.keys(q.map||{}).length}`; return `<div class="q"><b>${i+1}. ${escapeHtml(q.prompt||'')}</b><div class="result">${good?'âœ… ÄÃºng':'âŒ Sai'} â€¢ ${detail}</div></div>`;}).join('');
    const bSubmit=$('#btn-submit'); if(bSubmit) bSubmit.disabled=true; btnPrev.disabled=true; if(btnNext) btnNext.disabled=true;
    window.scrollTo({top:0,behavior:'smooth'});
  }

  setProgress(); draw();
}

/* ===== INIT ===== */
(function init(){ route(); })();
</script>
</body>
</html>
